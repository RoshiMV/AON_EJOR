Sets
i suppliers /1*7/
u scenarios /1*128/

Parameters
c(i) selling price
/
1	42
2	42
3	45
4	46
5	47
6	52
7	52
/
pi(i) probability of each supplier's availability
/
1	0.907254
2	0.916013
3	0.653142
4	0.54387
5	0.638279
6	0.586184
7	0.706015
/
Prob(u) Scenario probability
/
1	5.42314e-05
2	0.000130239
3	7.68207e-05
4	0.000184488
5	9.56949e-05
6	0.000229815
7	0.000135555
8	0.00032554
9	6.46633e-05
10	0.000155291
11	9.15979e-05
12	0.000219976
13	0.000114103
14	0.000274022
15	0.00016163
16	0.000388161
17	0.000102119
18	0.000245243
19	0.000144655
20	0.000347395
21	0.000180196
22	0.000432746
23	0.000255253
24	0.000613
25	0.000121763
26	0.000292417
27	0.000172481
28	0.000414219
29	0.000214858
30	0.000515989
31	0.000304354
32	0.000730916
33	0.000591481
34	0.00142046
35	0.000837854
36	0.00201214
37	0.00104371
38	0.0025065
39	0.00147845
40	0.00355054
41	0.000705258
42	0.0016937
43	0.000999022
44	0.00239919
45	0.00124447
46	0.00298865
47	0.00176284
48	0.00423352
49	0.00111377
50	0.00267477
51	0.0015777
52	0.0037889
53	0.00196532
54	0.0047198
55	0.00278395
56	0.00668576
57	0.00132802
58	0.00318928
59	0.00188118
60	0.00451773
61	0.00234337
62	0.00562769
63	0.00331947
64	0.00797182
65	0.000530501
66	0.00127402
67	0.000751473
68	0.00180469
69	0.000936103
70	0.00224809
71	0.00132602
72	0.00318449
73	0.000632548
74	0.00151909
75	0.000896025
76	0.00215184
77	0.00111617
78	0.00268053
79	0.00158109
80	0.00379706
81	0.000998945
82	0.002399
83	0.00141504
84	0.00339827
85	0.0017627
86	0.0042332
87	0.00249693
88	0.00599647
89	0.0011911
90	0.00286047
91	0.00168724
92	0.00405196
93	0.00210178
94	0.00504749
95	0.00297724
96	0.00714994
97	0.00578597
98	0.0138952
99	0.00819602
100	0.019683
101	0.0102097
102	0.024519
103	0.0144624
104	0.034732
105	0.00689895
106	0.0165681
107	0.0097726
108	0.0234693
109	0.0121736
110	0.0292354
111	0.0172444
112	0.041413
113	0.0108951
114	0.026165
115	0.0154333
116	0.0370636
117	0.0192251
118	0.0461698
119	0.0272331
120	0.0654012
121	0.0129909
122	0.0311981
123	0.018402
124	0.0441932
125	0.0229233
126	0.055051
127	0.0324716
128	0.0779817
/
Table
R(u,i)  availability
	1	2	3	4	5	6	7	
1	0	0	0	0	0	0	0	
2	0	0	0	0	0	0	1	
3	0	0	0	0	0	1	0	
4	0	0	0	0	0	1	1	
5	0	0	0	0	1	0	0	
6	0	0	0	0	1	0	1	
7	0	0	0	0	1	1	0	
8	0	0	0	0	1	1	1	
9	0	0	0	1	0	0	0	
10	0	0	0	1	0	0	1	
11	0	0	0	1	0	1	0	
12	0	0	0	1	0	1	1	
13	0	0	0	1	1	0	0	
14	0	0	0	1	1	0	1	
15	0	0	0	1	1	1	0	
16	0	0	0	1	1	1	1	
17	0	0	1	0	0	0	0	
18	0	0	1	0	0	0	1	
19	0	0	1	0	0	1	0	
20	0	0	1	0	0	1	1	
21	0	0	1	0	1	0	0	
22	0	0	1	0	1	0	1	
23	0	0	1	0	1	1	0	
24	0	0	1	0	1	1	1	
25	0	0	1	1	0	0	0	
26	0	0	1	1	0	0	1	
27	0	0	1	1	0	1	0	
28	0	0	1	1	0	1	1	
29	0	0	1	1	1	0	0	
30	0	0	1	1	1	0	1	
31	0	0	1	1	1	1	0	
32	0	0	1	1	1	1	1	
33	0	1	0	0	0	0	0	
34	0	1	0	0	0	0	1	
35	0	1	0	0	0	1	0	
36	0	1	0	0	0	1	1	
37	0	1	0	0	1	0	0	
38	0	1	0	0	1	0	1	
39	0	1	0	0	1	1	0	
40	0	1	0	0	1	1	1	
41	0	1	0	1	0	0	0	
42	0	1	0	1	0	0	1	
43	0	1	0	1	0	1	0	
44	0	1	0	1	0	1	1	
45	0	1	0	1	1	0	0	
46	0	1	0	1	1	0	1	
47	0	1	0	1	1	1	0	
48	0	1	0	1	1	1	1	
49	0	1	1	0	0	0	0	
50	0	1	1	0	0	0	1	
51	0	1	1	0	0	1	0	
52	0	1	1	0	0	1	1	
53	0	1	1	0	1	0	0	
54	0	1	1	0	1	0	1	
55	0	1	1	0	1	1	0	
56	0	1	1	0	1	1	1	
57	0	1	1	1	0	0	0	
58	0	1	1	1	0	0	1	
59	0	1	1	1	0	1	0	
60	0	1	1	1	0	1	1	
61	0	1	1	1	1	0	0	
62	0	1	1	1	1	0	1	
63	0	1	1	1	1	1	0	
64	0	1	1	1	1	1	1	
65	1	0	0	0	0	0	0	
66	1	0	0	0	0	0	1	
67	1	0	0	0	0	1	0	
68	1	0	0	0	0	1	1	
69	1	0	0	0	1	0	0	
70	1	0	0	0	1	0	1	
71	1	0	0	0	1	1	0	
72	1	0	0	0	1	1	1	
73	1	0	0	1	0	0	0	
74	1	0	0	1	0	0	1	
75	1	0	0	1	0	1	0	
76	1	0	0	1	0	1	1	
77	1	0	0	1	1	0	0	
78	1	0	0	1	1	0	1	
79	1	0	0	1	1	1	0	
80	1	0	0	1	1	1	1	
81	1	0	1	0	0	0	0	
82	1	0	1	0	0	0	1	
83	1	0	1	0	0	1	0	
84	1	0	1	0	0	1	1	
85	1	0	1	0	1	0	0	
86	1	0	1	0	1	0	1	
87	1	0	1	0	1	1	0	
88	1	0	1	0	1	1	1	
89	1	0	1	1	0	0	0	
90	1	0	1	1	0	0	1	
91	1	0	1	1	0	1	0	
92	1	0	1	1	0	1	1	
93	1	0	1	1	1	0	0	
94	1	0	1	1	1	0	1	
95	1	0	1	1	1	1	0	
96	1	0	1	1	1	1	1	
97	1	1	0	0	0	0	0	
98	1	1	0	0	0	0	1	
99	1	1	0	0	0	1	0	
100	1	1	0	0	0	1	1	
101	1	1	0	0	1	0	0	
102	1	1	0	0	1	0	1	
103	1	1	0	0	1	1	0	
104	1	1	0	0	1	1	1	
105	1	1	0	1	0	0	0	
106	1	1	0	1	0	0	1	
107	1	1	0	1	0	1	0	
108	1	1	0	1	0	1	1	
109	1	1	0	1	1	0	0	
110	1	1	0	1	1	0	1	
111	1	1	0	1	1	1	0	
112	1	1	0	1	1	1	1	
113	1	1	1	0	0	0	0	
114	1	1	1	0	0	0	1	
115	1	1	1	0	0	1	0	
116	1	1	1	0	0	1	1	
117	1	1	1	0	1	0	0	
118	1	1	1	0	1	0	1	
119	1	1	1	0	1	1	0	
120	1	1	1	0	1	1	1	
121	1	1	1	1	0	0	0	
122	1	1	1	1	0	0	1	
123	1	1	1	1	0	1	0	
124	1	1	1	1	0	1	1	
125	1	1	1	1	1	0	0	
126	1	1	1	1	1	0	1	
127	1	1	1	1	1	1	0	
128	1	1	1	1	1	1	1	

Scalars
h cost of unsold item / 5 /
rc reservation cost at the backup supplier /20 /
ec execution cost at the backup supplier /26 /
mu demand mean / 800 /
sd demand stdev / 50 /
muSP spot market price mean / 240 /
sdSP spot market price stdev / 10 /
telapsed;

Parameter
zSP, pdfSP, cdfSp, delta;
zSP = (ec - muSP) / sdSP;
pdfSP =  exp(-0.5*power(zSp,2))/sqrt(2*3.14156);
cdfSP =  0.5*(1+sqrt(1-exp(-5*power(zSP,2)*0.125)));
If (zSP >= 0, 
         delta = sdSP * pdfSP -  sdSP * zSP *(1-cdfSP);
else  
         delta = sdSP * pdfSP -  sdSP * zSP *(cdfSP);
);

Variables
z(u) service level for scenario u
zKR(u)
expected expected profit;

Positive variables
pdf(u)    pdf for scenario u
cdf(u)    cdf for scenario u
TotalQ(u) total order quantity for scenario u
pdfKR(u)  pdf including KR for scenario u
cdfKR(u)  cdf including KR for scenario u
loss(u)   loss value for Qu scenario u
lossKR(u) loss value for Qu + KR for scenario u
cost(u)   cost scenario u
q(i)      order quantity for supplier i
KR        capacity reserved at the backup supplier;

Equations
objective        define objective function
scenarioCost(u)  scenario cost definition
calcTotalQ(u)    calculate total order for each scenarion
calcLoss(u)      define loss constraint Qu scenario u
calcLossKR(u)    define loss constraint Qu + KR scenario u
calcpdf(u)       calculate pdf of Qu for scenario u
calccdf(u)       calculate cdf of Qu for scenario u
calcpdfKR(u)     calculate pdf of Qu + KR
calccdfKR(u)     calculate cdf of Qu+KR
calcz(u)         calculate z(u)
calczKR(u)       calculate zKR(u);

objective..              expected=e= sum((u), Prob(u)*cost(u));
scenarioCost(u)..        cost(u)=e=  sum((i),c(i)*q(i)*R(u,i))+ rc*KR +
                         h*(TotalQ(u)-mu) + (h+muSP-delta)* loss(u)+ 
                         delta * lossKR(u); 
calcTotalQ(u)..          TotalQ(u) =e=  sum((i), q(i)*R(u,i));
calcLoss(u)..            loss(u)=e=sd*(pdf(u) -z(u)*(1-cdf(u)));
calcLossKR(u)..          lossKR(u) =e= sd*(pdfKR(u) -zKR(u)*(1-cdfKR(u)));
calcpdf(u)..             pdf(u)*sqrt(2*3.14156)=e=exp(-0.5*power(z(u),2));
calccdf(u)..             cdf(u)=e= errorf(z(u));
calcpdfKR(u)..           pdfKR(u)*sqrt(2*3.14156)=e=exp(-0.5*power(zKR(u),2));
calccdfKR(u)..           cdfKR(u)=e= errorf(zKR(u));
calcz(u)..               TotalQ(u)=e=mu+sd*z(u); 
calczKR(u)..             TotalQ(u)+KR=e=mu+sd*zKR(u);
cdf.up(u)=1;
cdf.lo(u)=0;
cdfKR.up(u)=1; 
cdfKR.lo(u)=0;
z.up(u)=20; 
z.lo(u)=-20;
zKR.up(u)=20;
zKR.lo(u)=-20;


Model AONnew / all / ;
option optcr = 1e-5;
option nlp=IPOPT;
option iterlim = 100000000;
option reslim = 5000;
option domlim = 2000000;
solve  AONnew using nlp minimizing expected;



Display AONnew.modelstat;
Display AONnew.solvestat;
telapsed = TimeElapsed;

file  Results storing the results / results_7_Exact_IPOPT.txt / ; 
Results.ap=1;
put Results;
*put /'Objective,Elapsed time','AONnew.solvestat','AONnew.modelstat/;
put /expected.l','telapsed','AONnew.solvestat','AONnew.modelstat/;
putclose Results;
